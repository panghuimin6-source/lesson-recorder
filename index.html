<script>
async function uploadRecording(blob) {
  try {
    // 1. 去后端拿 token
    const tokenRes = await fetch('/api/get-upload-token');
    const { token } = await tokenRes.json();
    console.log("拿到的 token:", token);

    // 2. 构造 FormData
    const formData = new FormData();
    const fileName = `record-${Date.now()}.mp3`;
    formData.append('file', blob, fileName);
    formData.append('token', token);
    formData.append('key', fileName);

    // 3. 上传到七牛（华东-2）
    const res = await fetch('https://up-cn-east-2.qiniup.com', {
      method: 'POST',
      body: formData
    });

    const text = await res.text();
    console.log("上传返回结果:", text);

    if (!res.ok) throw new Error('上传失败');

    // 4. 播放地址
    const fileUrl = `http://t1i0t9lk0.hd-bkt.clouddn.com/${fileName}`;
    console.log("播放 URL:", fileUrl);
    alert('上传成功！可播放 URL 已生成');

    // 5. 页面上播放
    const audio = document.createElement('audio');
    audio.controls = true;
    audio.src = fileUrl;
    document.body.appendChild(audio);

  } catch (err) {
    console.error("上传出错:", err);
    alert('上传发生错误');
  }
}
</script>
