<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>录音上传示例</title>
</head>
<body>
  <h1>录音上传到七牛示例</h1>

  <button id="startBtn">开始录音</button>
  <button id="stopBtn">停止录音</button>
  <button id="uploadBtn">上传录音</button>

  <script>
  let mediaRecorder;
  let audioChunks = [];

  // 开始录音
  document.getElementById('startBtn').onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.start();
    alert('开始录音');
  };

  // 停止录音
  document.getElementById('stopBtn').onclick = () => {
    if (!mediaRecorder) return alert('请先开始录音');
    mediaRecorder.stop();
    mediaRecorder.onstop = () => alert('录音停止，准备上传');
  };

  // 上传录音到后端
  document.getElementById('uploadBtn').onclick = async () => {
    if (audioChunks.length === 0) return alert('没有录音可以上传');
    const blob = new Blob(audioChunks, { type: 'audio/mp3' });
    const formData = new FormData();
    formData.append('file', blob, `record-${Date.now()}.mp3`);

    try {
      const res = await fetch('/api/upload', { method: 'POST', body: formData });
      const data = await res.json();
      if (data.url) {
        alert('上传成功！可播放 URL 已生成');
        let audio = document.querySelector('#uploadedPlayer');
        if (!audio) {
          audio = document.createElement('audio');
          audio.id = 'uploadedPlayer';
          audio.controls = true;
          document.body.appendChild(audio);
        }
        audio.src = data.url;
      } else {
        alert('上传失败：' + (data.error || '未知错误'));
      }
    } catch (err) {
      alert('上传失败：' + err.message);
    }
  };
  </script>
</body>
</html>
